#!/usr/bin/env bash

# Copyright Â© 2019 Jakub Wilk <jwilk@jwilk.net>
# SPDX-License-Identifier: MIT

set -e -u
prog=${0##*/}
bad_usage()
{
    printf 'Usage: %s PROVIDER IDENT\n' "$prog" >&2
    printf 'Providers: inpost paczkawruchu poczta-polska\n' >&2
    exit 1
}
[ $# -eq 2 ] || bad_usage
provider="$1"
ident="$2"

curlopts=()
urlget()
{
    curl \
        "${curlopts[@]}" \
        --user-agent 'pacz (https://github.com/jwilk/pacz)' \
        --silent --fail --show-error \
        "$@"
}
useca()
{
    local cadir='/usr/share/ca-certificates/mozilla'
    local cafile="$cadir/${1}.crt"
    if [ -d "$cadir" ]
    then
        curlopts+=(--cacert "$cafile" --capath /nonexistent)
    fi
}

case $provider in
    inpost)
        useca 'DigiCert_Global_Root_CA'
        url="https://api-shipx-pl.easypack24.net/v1/tracking/$ident"
        json=$(urlget "$url")
        jq . <<< "$json"
        ;;
    paczkawruchu)
        useca 'DigiCert_Global_Root_G2'
        ts=$(date '+%s000')
        url="https://nadaj.paczkawruchu.pl/parcel/api-status?id=$ident&jsonp=callback&_=$ts"
        json=$(urlget "$url")
        json=${json#callback(}
        json=${json%);}
        jq 'del(.historyHtml, .full)' <<< "$json"
        ;;
    poczta-polska)
        useca 'Certum_Trusted_Network_CA'
        tmpdir=$(mktemp -d -t pacz.XXXXXX)
        url="https://emonitoring.poczta-polska.pl"
        cookiejar="$tmpdir/cookies"
        urlget -c "$cookiejar" "$url" > /dev/null
        sid=$(grep -w PHPSESSID "$cookiejar" | cut -f 7)
        html=$(urlget -b "$cookiejar" -e "$url/" -d "s=$sid" -d "n=$ident" -d 'l=' "$url/wssClient.php")
        perl -0777 <<< "$html" -e '
            $_ = <STDIN>;
            m{<table\b[^>]*>(.*?)</table>};
            $_ = $1;
            s{<a\b[^>]*>(.*?)</a>}{$1}g;
            s{<tr\b[^>]*>}{\n}g;
            s{<t[dh]\b[^>]*>}{ | }g;
            s{^ [|] }{}mg;
            s{</t[hdr]>}{}g;
            s{  *}{ }g;
            s{^\s}{};
            print "$_\n";
        '
        rm -rf "$tmpdir"
        ;;
    *)
        bad_usage;;
esac

# vim:ts=4 sts=4 sw=4 et
